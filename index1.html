<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">

    <title>Script processor node example</title>

    <link rel="stylesheet" href="">
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>

  <body>
    <h1>ScriptProcessorNode example</h1>

    <button>Play song</button>

    <pre></pre>
    <script>
     const promisifiedOldGUM = function(constraints) {
		 // First get ahold of getUserMedia, if present
		 const getUserMedia =navigator.getUserMedia || navigator.webkitGetUserMedia ||navigator.mozGetUserMedia;
		  
		 // Some browsers just don't implement it - return a rejected promise with an error
		 // to keep a consistent interface
		 if (!getUserMedia) {
			 return Promise.reject(new Error('getUserMedia is not implemented in this browser')
			 );
		 }
		  
		 // Otherwise, wrap the call to the old navigator.getUserMedia with a Promise
		 return new Promise(function(resolve, reject) {getUserMedia.call(navigator, constraints, resolve, reject);});
		};
		  
		// Older browsers might not implement mediaDevices at all, so we set an empty object first
		if (navigator.mediaDevices === undefined) {navigator.mediaDevices = {};}
		  
		// Some browsers partially implement mediaDevices. We can't just assign an object
		// with getUserMedia as it would overwrite existing properties.
		// Here, we will just add the getUserMedia property if it's missing.
		if (navigator.mediaDevices.getUserMedia === undefined) {navigator.mediaDevices.getUserMedia = promisifiedOldGUM;}

		navigator.mediaDevices.getUserMedia(constraints).then(
		 function(mediaStream) {
		 // 成功
		 },
		 function(error) {
			 // 失败
			 const { name } = error;
			 let errorMessage;
			 switch (name) {
			 // 用户拒绝
			 case 'NotAllowedError':
			 case 'PermissionDeniedError':
			 errorMessage = '用户已禁止网页调用录音设备';
			 break;
			 // 没接入录音设备
			 case 'NotFoundError':
			 case 'DevicesNotFoundError':
			 errorMessage = '录音设备未找到';
			 break;
			 // 其它错误
			 case 'NotSupportedError':
			 errorMessage = '不支持录音功能';
			 break;
			 default:
			 errorMessage = '录音调用错误';
			 alert(error);
			 }
			 return errorMessage;
		 }
		);

		// 一些初始化
		const audioContext = new AudioContext();
		const sourceNode = audioContext.createMediaStreamSource(mediaStream);
		const scriptNode = audioContext.createScriptProcessor(BUFFER_SIZE,INPUT_CHANNELS_NUM,OUPUT_CHANNELS_NUM);
		sourceNode.connect(this.scriptNode);
		scriptNode.connect(this.audioContext.destination);
		// 监听录音的过程
		scriptNode.onaudioprocess = event => {
			if (!this.isRecording) return; // 判断是否正则录音
			this.buffers.push(event.inputBuffer.getChannelData(0)); // 获取当前频道的数据，并写入数组
		};
		
		const getDuration = () => {
			return (4096 * this.buffers.length) / this.audioContext.sampleRate // 4096为一个流的长度，sampleRate 为采样率
		}
    </script>
  </body>
</html>